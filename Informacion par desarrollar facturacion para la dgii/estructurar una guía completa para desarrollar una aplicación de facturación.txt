Voy a estructurar una guía completa para desarrollar una aplicación de facturación electrónica en República Dominicana que cumpla con todas las normativas de la DGII. Primero, identificaré los componentes principales y luego diseñaré un modelo de datos adecuado.

# README.md - Sistema de Facturación Electrónica (e-CF)

## Introducción

Este proyecto implementa un sistema completo de facturación electrónica compatible con las normativas de la Dirección General de Impuestos Internos (DGII) de República Dominicana. El sistema permite la emisión, recepción, consulta y gestión de Comprobantes Fiscales Electrónicos (e-CF) según lo establecido en la Norma General 01-2020 y la Ley 32-23 de Facturación Electrónica.

## Arquitectura

El sistema se divide en los siguientes módulos principales:

1. *Autenticación y Gestión de Usuarios*
   - Manejo de usuarios, roles y permisos
   - Integración con certificados digitales para firma electrónica

2. *Emisión de Comprobantes*
   - Generación de XML de e-CF
   - Firmado digital de comprobantes
   - Envío a la DGII y receptores

3. *Recepción de Comprobantes*
   - Recepción de e-CF de otros emisores
   - Generación de acuses de recibo
   - Gestión de aprobaciones/rechazos comerciales

4. *Consultas y Reportes*
   - Consulta de comprobantes emitidos/recibidos
   - Generación de reportes de ventas/compras

5. *Gestión de Contingencias*
   - Manejo de escenarios sin conexión
   - Sustitución de comprobantes en contingencia

6. *API Servicios Web*
   - Endpoints para integración con la DGII y otros contribuyentes

## Modelo de datos

A continuación se presentan las principales entidades y sus relaciones:

### Modelo de bases de datos

Consulta el archivo [DATABASE_SCHEMA.md](DATABASE_SCHEMA.md) para ver la estructura completa de la base de datos.

## Requisitos técnicos

- *Lenguaje backend*: [Especificar lenguaje]
- *Frameworks*: [Especificar frameworks]
- *Base de datos*: [Especificar base de datos]
- *Frontend*: [Especificar tecnologías frontend]
- *Infraestructura*:
  - Servidor HTTPS
  - Almacenamiento seguro para certificados digitales
  - Sistema de respaldo de datos

## Servicios web a implementar

Para interactuar con la DGII y otros contribuyentes, el sistema debe implementar los siguientes servicios:

- Autenticación (opcional)
- Recepción de e-CF
- Recepción de aprobaciones comerciales

Consulta el archivo [WEB_SERVICES.md](WEB_SERVICES.md) para ver las especificaciones detalladas.

## Configuración e instalación

Consulta el archivo [INSTALLATION.md](INSTALLATION.md) para instrucciones detalladas sobre la instalación y configuración del sistema.

## Flujos de trabajo

Consulta el archivo [WORKFLOWS.md](WORKFLOWS.md) para ver los diagramas y descripciones de los principales flujos de trabajo del sistema.

# DATABASE_SCHEMA.md

## Estructura de la base de datos

### Tablas principales

#### 1. Contribuyentes

sql
CREATE TABLE contribuyentes (
    id SERIAL PRIMARY KEY,
    rnc VARCHAR(11) NOT NULL UNIQUE,
    razon_social VARCHAR(150) NOT NULL,
    nombre_comercial VARCHAR(150),
    direccion VARCHAR(100) NOT NULL,
    municipio_id INTEGER REFERENCES municipios(id),
    provincia_id INTEGER REFERENCES provincias(id),
    es_emisor_electronico BOOLEAN DEFAULT FALSE,
    es_receptor_electronico BOOLEAN DEFAULT FALSE,
    es_proveedor_servicios BOOLEAN DEFAULT FALSE,
    url_recepcion VARCHAR(255),
    url_aprobacion VARCHAR(255),
    url_autenticacion VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 2. Representantes

sql
CREATE TABLE representantes (
    id SERIAL PRIMARY KEY,
    contribuyente_id INTEGER REFERENCES contribuyentes(id),
    nombre VARCHAR(150) NOT NULL,
    tipo_documento ENUM('cedula', 'pasaporte') NOT NULL,
    documento VARCHAR(20) NOT NULL,
    email VARCHAR(80) NOT NULL,
    telefono VARCHAR(12),
    certificado_digital_id INTEGER REFERENCES certificados_digitales(id),
    activo BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 3. Certificados Digitales

sql
CREATE TABLE certificados_digitales (
    id SERIAL PRIMARY KEY,
    contribuyente_id INTEGER REFERENCES contribuyentes(id),
    representante_id INTEGER REFERENCES representantes(id),
    numero_serie VARCHAR(100) NOT NULL,
    entidad_certificadora VARCHAR(100) NOT NULL,
    fecha_emision DATE NOT NULL,
    fecha_vencimiento DATE NOT NULL,
    ruta_certificado VARCHAR(255) NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 4. Secuencias e-NCF

sql
CREATE TABLE secuencias_encf (
    id SERIAL PRIMARY KEY,
    contribuyente_id INTEGER REFERENCES contribuyentes(id),
    tipo_comprobante VARCHAR(2) NOT NULL,
    serie CHAR(1) NOT NULL,
    secuencial_desde BIGINT NOT NULL,
    secuencial_hasta BIGINT NOT NULL,
    secuencial_actual BIGINT,
    fecha_vencimiento DATE NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 5. Comprobantes Fiscales Electrónicos

sql
CREATE TABLE comprobantes_fiscales (
    id SERIAL PRIMARY KEY,
    contribuyente_emisor_id INTEGER REFERENCES contribuyentes(id),
    contribuyente_receptor_id INTEGER REFERENCES contribuyentes(id),
    tipo_comprobante VARCHAR(2) NOT NULL,
    encf VARCHAR(13) NOT NULL UNIQUE,
    fecha_emision DATE NOT NULL,
    fecha_firma TIMESTAMP NOT NULL,
    monto_gravado_total DECIMAL(18,2) DEFAULT 0,
    monto_exento DECIMAL(18,2) DEFAULT 0,
    total_itbis DECIMAL(18,2) DEFAULT 0,
    monto_impuesto_adicional DECIMAL(18,2) DEFAULT 0,
    monto_total DECIMAL(18,2) NOT NULL,
    codigo_seguridad VARCHAR(6) NOT NULL,
    estado ENUM('aceptado', 'aceptado_condicional', 'rechazado', 'en_proceso') DEFAULT 'en_proceso',
    track_id VARCHAR(36),
    xml_original LONGTEXT NOT NULL,
    qr_code LONGTEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 6. Detalles de Comprobantes

sql
CREATE TABLE detalles_comprobantes (
    id SERIAL PRIMARY KEY,
    comprobante_id INTEGER REFERENCES comprobantes_fiscales(id),
    numero_linea INTEGER NOT NULL,
    indicador_facturacion CHAR(1) NOT NULL,
    nombre_item VARCHAR(80) NOT NULL,
    indicador_bien_servicio CHAR(1) NOT NULL,
    cantidad DECIMAL(18,2) NOT NULL,
    unidad_medida INTEGER,
    precio_unitario DECIMAL(20,4) NOT NULL,
    monto_descuento DECIMAL(18,2) DEFAULT 0,
    monto_recargo DECIMAL(18,2) DEFAULT 0,
    monto_item DECIMAL(18,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 7. Impuestos Adicionales

sql
CREATE TABLE impuestos_adicionales (
    id SERIAL PRIMARY KEY,
    detalle_comprobante_id INTEGER REFERENCES detalles_comprobantes(id),
    codigo_impuesto VARCHAR(3) NOT NULL,
    tasa_impuesto DECIMAL(5,2) NOT NULL,
    monto_isc_especifico DECIMAL(18,2) DEFAULT 0,
    monto_isc_advalorem DECIMAL(18,2) DEFAULT 0,
    monto_otros_impuestos DECIMAL(18,2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 8. Acuses de Recibo

sql
CREATE TABLE acuses_recibo (
    id SERIAL PRIMARY KEY,
    comprobante_id INTEGER REFERENCES comprobantes_fiscales(id),
    contribuyente_emisor_id INTEGER REFERENCES contribuyentes(id),
    contribuyente_receptor_id INTEGER REFERENCES contribuyentes(id),
    encf VARCHAR(13) NOT NULL,
    estado CHAR(1) NOT NULL,
    codigo_motivo_no_recibido VARCHAR(1),
    fecha_hora_acuse TIMESTAMP NOT NULL,
    xml_acuse LONGTEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 9. Aprobaciones Comerciales

sql
CREATE TABLE aprobaciones_comerciales (
    id SERIAL PRIMARY KEY,
    comprobante_id INTEGER REFERENCES comprobantes_fiscales(id),
    contribuyente_emisor_id INTEGER REFERENCES contribuyentes(id),
    contribuyente_receptor_id INTEGER REFERENCES contribuyentes(id),
    encf VARCHAR(13) NOT NULL,
    fecha_aprobacion TIMESTAMP NOT NULL,
    estado BOOLEAN NOT NULL,
    comentario TEXT,
    xml_aprobacion LONGTEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 10. Anulaciones de Secuencias

sql
CREATE TABLE anulaciones_secuencias (
    id SERIAL PRIMARY KEY,
    contribuyente_id INTEGER REFERENCES contribuyentes(id),
    tipo_comprobante VARCHAR(2) NOT NULL,
    serie CHAR(1) NOT NULL,
    secuencial_desde BIGINT NOT NULL,
    secuencial_hasta BIGINT NOT NULL,
    cantidad_anulados INTEGER NOT NULL,
    fecha_anulacion TIMESTAMP NOT NULL,
    xml_anulacion LONGTEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 11. Contingencias

sql
CREATE TABLE contingencias (
    id SERIAL PRIMARY KEY,
    contribuyente_id INTEGER REFERENCES contribuyentes(id),
    tipo_contingencia ENUM('total', 'parcial') NOT NULL,
    fecha_inicio TIMESTAMP NOT NULL,
    fecha_fin TIMESTAMP,
    motivo TEXT NOT NULL,
    estado ENUM('activa', 'finalizada') DEFAULT 'activa',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


#### 12. Comprobantes en Contingencia

sql
CREATE TABLE comprobantes_contingencia (
    id SERIAL PRIMARY KEY,
    contingencia_id INTEGER REFERENCES contingencias(id),
    ncf_contingencia VARCHAR(11) NOT NULL,
    encf_reemplazo VARCHAR(13),
    fecha_emision DATE NOT NULL,
    monto_total DECIMAL(18,2) NOT NULL,
    estado ENUM('pendiente', 'reemplazado') DEFAULT 'pendiente',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


### Tablas de catálogos

#### 13. Provincias

sql
CREATE TABLE provincias (
    id INTEGER PRIMARY KEY,
    codigo VARCHAR(6) NOT NULL UNIQUE,
    nombre VARCHAR(100) NOT NULL
);


#### 14. Municipios

sql
CREATE TABLE municipios (
    id INTEGER PRIMARY KEY,
    provincia_id INTEGER REFERENCES provincias(id),
    codigo VARCHAR(6) NOT NULL UNIQUE,
    nombre VARCHAR(100) NOT NULL
);


#### 15. Tipos de Impuestos Adicionales

sql
CREATE TABLE tipos_impuestos_adicionales (
    id SERIAL PRIMARY KEY,
    codigo VARCHAR(3) NOT NULL UNIQUE,
    nombre VARCHAR(100) NOT NULL,
    abreviatura VARCHAR(20) NOT NULL,
    descripcion VARCHAR(255) NOT NULL,
    tasa DECIMAL(5,2) NOT NULL
);


#### 16. Unidades de Medida

sql
CREATE TABLE unidades_medida (
    id SERIAL PRIMARY KEY,
    codigo INTEGER NOT NULL UNIQUE,
    abreviatura VARCHAR(10) NOT NULL,
    nombre VARCHAR(100) NOT NULL
);


#### 17. Monedas

sql
CREATE TABLE monedas (
    id SERIAL PRIMARY KEY,
    codigo VARCHAR(3) NOT NULL UNIQUE,
    nombre VARCHAR(100) NOT NULL
);


# WEB_SERVICES.md

## Servicios Web a Implementar

### 1. Servicio de Autenticación (Opcional)

El servicio de autenticación permite validar la identidad de un contribuyente mediante el uso de un certificado digital. Este servicio consta de dos endpoints:

#### 1.1. Obtener Semilla

*URL:* /fe/autenticacion/api/semilla
*Método:* GET
*Respuesta:* Archivo XML con un valor único (semilla)

xml
<?xml version="1.0" encoding="utf-8"?>
<SemillaModel xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
    <valor>0000000-0000-0000-0000-000000000000</valor>
    <fecha>2022-07-27T11:59:31.3551245-04:00</fecha>
</SemillaModel>


#### 1.2. Validar Certificado

*URL:* /fe/autenticacion/api/validacioncertificado
*Método:* POST
*Parámetros:* XML firmado con la semilla obtenida previamente
*Respuesta:* Token de autenticación con fecha de expedición y vencimiento

json
{
  "token": "string",
  "expira": "yyyy-MM-ddTHH:mm:ssZ",
  "expedido": "yyyy-MM-ddTHH:mm:ssZ"
}


### 2. Servicio de Recepción de e-CF

Este servicio permite recibir comprobantes fiscales electrónicos de otros emisores.

*URL:* /fe/recepcion/api/ecf
*Método:* POST
*Parámetros:* XML del e-CF
*Headers:* Authorization: Bearer {token} (si se implementa autenticación)
*Respuesta:* XML de acuse de recibo

xml
<?xml version="1.0" encoding="utf-8"?>
<ARECF xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
    <DetalleAcusedeRecibo>
        <Version>1.0</Version>
        <RNCEmisor>131880600</RNCEmisor>
        <RNCComprador>132880600</RNCComprador>
        <eNCF>E310000000001</eNCF>
        <Estado>0</Estado>
        <FechaHoraAcuseRecibo>17-12-2020 11:19:06</FechaHoraAcuseRecibo>
    </DetalleAcusedeRecibo>
</ARECF>


### 3. Servicio de Aprobación Comercial

Este servicio permite recibir aprobaciones o rechazos comerciales de los e-CF emitidos.

*URL:* /fe/aprobacioncomercial/api/ecf
*Método:* POST
*Parámetros:* XML de aprobación comercial
*Headers:* Authorization: Bearer {token} (si se implementa autenticación)
*Respuesta:* 
- HTTP 200: Satisfactorio
- HTTP 400: Error

## Interacción con Servicios de la DGII

El sistema debe interactuar con los siguientes servicios de la DGII:

### 1. Autenticación

*URL:* https://ecf.dgii.gov.do/{ambiente}/autenticacion
*Ambiente:* ecf (producción), certecf (certificación), testecf (pre-certificación)

### 2. Recepción de e-CF

*URL:* https://ecf.dgii.gov.do/{ambiente}/recepcion
*Ambiente:* ecf (producción), certecf (certificación), testecf (pre-certificación)

### 3. Recepción de Resumen de Factura de Consumo Electrónica (<DOP$250,000)

*URL:* https://fc.dgii.gov.do/{ambiente}/recepcionfc/
*Ambiente:* ecf (producción), testecf (pre-certificación)

### 4. Consulta de Resultado

*URL:* https://ecf.dgii.gov.do/{ambiente}/consultaresultado
*Ambiente:* ecf (producción), certecf (certificación), testecf (pre-certificación)

### 5. Consulta de Estado

*URL:* https://ecf.dgii.gov.do/{ambiente}/consultaestado
*Ambiente:* ecf (producción), testecf (pre-certificación)

### 6. Anulación de e-NCF

*URL:* https://ecf.dgii.gov.do/{ambiente}/anulacionrangos
*Ambiente:* ecf (producción), testecf (pre-certificación)

### 7. Consulta Directorio de Servicios

*URL:* https://ecf.dgii.gov.do/{ambiente}/consultadirectorio
*Ambiente:* ecf (producción), testecf (pre-certificación)

# WORKFLOWS.md

## Flujos de trabajo principales

### 1. Emisión de un e-CF

1. El usuario inicia la creación de un e-CF en el sistema
2. El sistema genera el XML del e-CF según el formato establecido
3. El sistema firma digitalmente el XML utilizando el certificado digital del contribuyente
4. El sistema envía el e-CF firmado a la DGII mediante el servicio de recepción
5. La DGII responde con un TrackId
6. El sistema consulta el estado del e-CF utilizando el TrackId
7. Si el estado es "Aceptado" o "Aceptado Condicional":
   - Si el receptor es electrónico, el sistema envía el e-CF al receptor
   - Si el receptor no es electrónico, el sistema genera la representación impresa del e-CF
8. Si el estado es "Rechazado", el sistema notifica al usuario sobre el rechazo y los motivos

### 2. Recepción de un e-CF

1. El sistema recibe un e-CF de otro emisor mediante el servicio de recepción
2. El sistema valida la estructura y firma del e-CF
3. El sistema genera y envía un acuse de recibo al emisor
4. El sistema almacena el e-CF en la base de datos
5. El sistema notifica al usuario sobre la recepción del e-CF
6. El usuario revisa el e-CF y decide aprobarlo o rechazarlo comercialmente
7. El sistema genera y envía la aprobación o rechazo comercial al emisor y a la DGII

### 3. Operación en Contingencia

#### 3.1. Falta de conectividad (Modo Offline/Intermitencia)

1. El sistema detecta problemas de conectividad
2. El sistema permite la emisión normal de e-CF y los almacena localmente
3. Una vez restablecida la conexión, el sistema envía automáticamente los e-CF pendientes a la DGII

#### 3.2. Incapacidad técnica para emitir e-CF

1. El usuario registra la contingencia en el sistema
2. El sistema habilita la emisión de comprobantes fiscales no electrónicos (serie B)
3. Una vez solucionada la contingencia, el usuario registra el fin de la misma
4. El sistema genera los e-CF correspondientes a los comprobantes emitidos en contingencia
5. El sistema envía los e-CF a la DGII con referencia a los comprobantes de contingencia

# INSTALLATION.md

## Requisitos del sistema

- [Lista de requisitos de hardware y software]

## Instalación

1. [Pasos de instalación]

## Configuración

### Configuración de la base de datos

1. [Pasos para configurar la base de datos]

### Configuración de certificados digitales

1. [Pasos para configurar los certificados digitales]

### Configuración de servicios web

1. [Pasos para configurar los servicios web]

## Integración con la DGII

### Ambiente de Pre-certificación

1. [Pasos para integrar con el ambiente de pre-certificación]

### Ambiente de Certificación

1. [Pasos para integrar con el ambiente de certificación]

### Ambiente de Producción

1. [Pasos para integrar con el ambiente de producción]
